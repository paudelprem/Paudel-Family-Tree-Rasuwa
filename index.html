<!DOCTYPE html>
<html lang="ne">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rasuwa Paudel ‚Äì Digital Banshawali</title>

<style>
body{margin:0;font-family:system-ui;background:#f5f2ea;overflow:hidden}
header{height:52px;background:#f4efe6;display:flex;align-items:center;
padding:0 16px;font-weight:600;gap:12px;border-bottom:1px solid #e0d8cd}
header button{padding:6px 12px;border:none;border-radius:6px;
background:#b36b2f;color:#fff;cursor:pointer}
#treeWrap{width:100vw;height:calc(100vh - 52px);
background:#f9f7f2;overflow:hidden;cursor:grab;position:relative}
#tree{position:absolute;transform-origin:0 0}

.tree-node{background:#fff;border:1px solid #cbb8a6;border-radius:12px;
padding:8px 10px;min-width:160px;text-align:center;cursor:pointer;
box-shadow:0 2px 6px rgba(0,0,0,.05)}
.tree-node img{width:56px;height:56px;border-radius:50%;
object-fit:cover;background:#ddd;pointer-events:none}
.tree-node .line{display:flex;justify-content:center;gap:6px;
align-items:center;margin-top:6px;font-weight:600}
.tree-node.alive .dot{color:green}
.tree-node.dead .dot{color:#444}
.gen{font-size:11px;background:#e6dfd6;border-radius:10px;
padding:2px 6px;margin-top:4px;display:inline-block}
.row{display:flex;gap:28px;justify-content:center;margin-bottom:16px}
.children{display:flex;gap:28px;justify-content:center}

.modal{display:none;position:fixed;inset:0;
background:rgba(0,0,0,.45);z-index:50}
.modal-box{background:#fff;max-width:820px;margin:20px auto;
padding:16px;border-radius:14px;max-height:92vh;overflow-y:auto}

.tabs{display:flex;gap:8px;margin-bottom:12px}
.tabs button{padding:6px 14px;border:none;border-radius:6px;
background:#e1dbd4;cursor:pointer}
.tabs button.active{background:#b36b2f;color:#fff}

label{font-size:13px;font-weight:600}
input,select,textarea{width:100%;padding:8px;margin:6px 0 12px 0;
border:1px solid #ccc;border-radius:6px}
textarea{min-height:70px}
.action{padding:8px 16px;background:#b36b2f;color:#fff;
border:none;border-radius:8px;cursor:pointer}
.gray{background:#777}
hr{border:none;border-top:1px solid #ddd;margin:14px 0}
</style>
</head>

<body>

<header>
üå≥ Digital Banshawali ‚Äì Rasuwa Paudel
<button onclick="exportJSON()">Backup</button>
<input type="file" id="importer" style="display:none" onchange="importJSON(event)">
<button onclick="document.getElementById('importer').click()" class="gray">Restore</button>
</header>

<div id="treeWrap"><div id="tree"></div></div>

<!-- MODAL -->
<div class="modal" id="modal">
<div class="modal-box">
<h2 id="modalName"></h2>

<div class="tabs">
<button id="tView" onclick="setTab('view')">View</button>
<button id="tEdit" onclick="setTab('edit')">Edit</button>
<button id="tRel" onclick="setTab('rel')">Relations</button>
</div>

<div id="tabView"></div>
<div id="tabEdit" style="display:none"></div>
<div id="tabRel" style="display:none"></div>

<hr>
<button class="action gray" onclick="closeModal()">Close</button>
</div>
</div>

<script>
/* ========= DATA ========= */
let persons={},current=null;
let scale=1,offset={x:window.innerWidth/2-160,y:20};
const gid=()=> "p"+Date.now();

function blank(id){
 return{
  id,name:"",gender:"‡§™‡•Å‡§∞‡•Å‡§∑",status:"alive",photo:"",
  birth:"",marriage:"",death:"",
  marital:"single",
  address:{origin:{},permanent:{},current:{}},
  profile:{biography:"",education:"",employment:""},
  father:null,mother:null,spouses:[],children:[]
 };
}

const saved=localStorage.getItem("banshawaliData");
if(saved){persons=JSON.parse(saved);current=Object.keys(persons)[0];}
else{
 let id=gid();
 persons[id]=blank(id);
 persons[id].name="‡§ß‡§∞‡•ç‡§Æ‡§¶‡§§‡•ç‡§§ ‡§™‡•å‡§°‡•á‡§≤";
 current=id;
 store();
}

function store(){localStorage.setItem("banshawaliData",JSON.stringify(persons));}

/* ========= TREE ========= */
function render(){
 tree.innerHTML="";
 tree.appendChild(build(findRoot(),1));
 applyTransform();
}
function findRoot(){
 return Object.values(persons).find(p=>!p.father&&!p.mother)?.id||current;
}
function build(id,gen){
 let p=persons[id]; if(!p)return document.createElement("div");
 let wrap=document.createElement("div");
 let row=document.createElement("div"); row.className="row";
 row.appendChild(node(p,gen));
 (p.spouses||[]).forEach(s=>persons[s]&&row.appendChild(node(persons[s],gen)));
 wrap.appendChild(row);

 let kids=(p.children||[]).map(i=>persons[i]).filter(Boolean);
 if(kids.length){
  let c=document.createElement("div"); c.className="children";
  kids.forEach(k=>c.appendChild(build(k.id,gen+1)));
  wrap.appendChild(c);
 }
 return wrap;
}
function node(p,gen){
 let d=document.createElement("div");
 d.className="tree-node "+(p.status==="dead"?"dead":"alive");
 d.innerHTML=`
 <img src="${p.photo||'https://via.placeholder.com/80'}">
 <div class="line">
   <span class="dot">${p.status==="dead"?"‚óè":"‚óè"}</span>
   <span>${p.name||"-"}</span>
 </div>
 <div class="gen">‡§™‡•Å.${gen}</div>`;
 d.onclick=()=>openModal(p.id);
 return d;
}

/* ========= PAN / ZOOM ========= */
treeWrap.onwheel=e=>{scale+=e.deltaY*-0.001;scale=Math.min(Math.max(.4,scale),2);applyTransform();}
let drag=false,start={};
treeWrap.onmousedown=e=>{drag=true;start={x:e.clientX-offset.x,y:e.clientY-offset.y}};
treeWrap.onmousemove=e=>{if(drag){offset.x=e.clientX-start.x;offset.y=e.clientY-start.y;applyTransform();}};
treeWrap.onmouseup=()=>drag=false;
function applyTransform(){tree.style.transform=`translate(${offset.x}px,${offset.y}px) scale(${scale})`;}

/* ========= MODAL ========= */
function openModal(id){
 current=id;
 modalName.innerText=persons[id].name||"-";
 loadView(); loadEdit(); loadRel();
 setTab("view");
 modal.style.display="block";
}
function closeModal(){modal.style.display="none";}

/* ========= VIEW ========= */
function link(id){return persons[id]?`<a href="#" onclick="openModal('${id}')">${persons[id].name}</a>`:"-";}
function loadView(){
 let p=persons[current];
 tabView.innerHTML=`
 <p><b>‡§≤‡§ø‡§ô‡•ç‡§ó:</b> ${p.gender}</p>
 <p><b>‡§∏‡•ç‡§•‡§ø‡§§‡§ø:</b> ${p.status==="dead"?"‡§¶‡§ø‡§µ‡§Ç‡§ó‡§§":"‡§ú‡•Ä‡§µ‡§ø‡§§"}</p>
 <p><b>‡§ú‡§®‡•ç‡§Æ:</b> ${p.birth||"-"}</p>
 <p><b>‡§µ‡§ø‡§µ‡§æ‡§π:</b> ${p.marriage||"-"}</p>
 <p><b>‡§Æ‡•É‡§§‡•ç‡§Ø‡•Å:</b> ${p.death||"-"}</p>
 <p><b>Father:</b> ${link(p.father)}</p>
 <p><b>Mother:</b> ${link(p.mother)}</p>
 <p><b>Spouse:</b> ${(p.spouses||[]).map(link).join(", ")||"-"}</p>
 <p><b>Children:</b> ${(p.children||[]).map(link).join(", ")||"-"}</p>
 <hr>
 <p>${p.profile.biography||""}</p>`;
}

/* ========= EDIT ========= */
function loadEdit(){
 let p=persons[current];
 tabEdit.innerHTML=`
 <label>‡§®‡§æ‡§Æ</label><input id="e_name" value="${p.name}">
 <label>‡§≤‡§ø‡§ô‡•ç‡§ó</label>
 <select id="e_gender">
  <option ${p.gender==="‡§™‡•Å‡§∞‡•Å‡§∑"?"selected":""}>‡§™‡•Å‡§∞‡•Å‡§∑</option>
  <option ${p.gender==="‡§Æ‡§π‡§ø‡§≤‡§æ"?"selected":""}>‡§Æ‡§π‡§ø‡§≤‡§æ</option>
 </select>
 <label>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
 <select id="e_status">
  <option value="alive" ${p.status==="alive"?"selected":""}>‡§ú‡•Ä‡§µ‡§ø‡§§</option>
  <option value="dead" ${p.status==="dead"?"selected":""}>‡§¶‡§ø‡§µ‡§Ç‡§ó‡§§</option>
 </select>
 <label>‡§ú‡§®‡•ç‡§Æ</label><input id="e_birth" value="${p.birth}">
 <label>‡§µ‡§ø‡§µ‡§æ‡§π</label><input id="e_marriage" value="${p.marriage}">
 <label>‡§Æ‡•É‡§§‡•ç‡§Ø‡•Å</label><input id="e_death" value="${p.death}">
 <label>Biography</label><textarea id="e_bio">${p.profile.biography||""}</textarea>
 <button class="action" onclick="save()">Save</button>
 <button class="action gray" onclick="delPerson()">Delete</button>`;
}
function save(){
 let p=persons[current];
 p.name=e_name.value;
 p.gender=e_gender.value;
 p.status=e_status.value;
 p.birth=e_birth.value;
 p.marriage=e_marriage.value;
 p.death=e_death.value;
 p.profile.biography=e_bio.value;
 store(); render(); openModal(current);
}
function delPerson(){
 if(!confirm("Delete this person?"))return;
 let id=current;
 delete persons[id];
 Object.values(persons).forEach(p=>{
  p.children=p.children.filter(c=>c!==id);
  p.spouses=p.spouses.filter(s=>s!==id);
  if(p.father===id)p.father=null;
  if(p.mother===id)p.mother=null;
 });
 store(); render(); closeModal();
}

/* ========= RELATIONS ========= */
function loadRel(){
 let p=persons[current];
 tabRel.innerHTML=`
 <button class="action" onclick="addParent('father')">Add Father</button>
 <button class="action" onclick="addParent('mother')">Add Mother</button><br><br>
 <button class="action" onclick="addPartner()">Add Spouse</button><br><br>
 <button class="action" onclick="addChild()">Add Child</button>`;
}
function addParent(type){
 let id=gid(); persons[id]=blank(id);
 persons[current][type]=id;
 persons[id].children.push(current);
 store(); render(); openModal(id);
}
function addPartner(){
 let id=gid(); persons[id]=blank(id);
 persons[current].spouses.push(id);
 persons[id].spouses.push(current);
 store(); render(); openModal(id);
}
function addChild(){
 let id=gid(); persons[id]=blank(id);
 let p=persons[current];
 if(p.gender==="‡§™‡•Å‡§∞‡•Å‡§∑"){persons[id].father=current;}
 else{persons[id].mother=current;}
 p.children.push(id);
 store(); render(); openModal(id);
}

/* ========= TABS ========= */
function setTab(t){
 tabView.style.display=t==="view"?"block":"none";
 tabEdit.style.display=t==="edit"?"block":"none";
 tabRel.style.display=t==="rel"?"block":"none";
 tView.classList.toggle("active",t==="view");
 tEdit.classList.toggle("active",t==="edit");
 tRel.classList.toggle("active",t==="rel");
}

/* ========= BACKUP ========= */
function exportJSON(){
 let b=new Blob([JSON.stringify(persons)],{type:"application/json"});
 let a=document.createElement("a");
 a.href=URL.createObjectURL(b);
 a.download="banshawali_backup.json";
 a.click();
}
function importJSON(e){
 let r=new FileReader();
 r.onload=x=>{persons=JSON.parse(x.target.result);store();render();};
 r.readAsText(e.target.files[0]);
}

/* INIT */
render();
</script>
</body>
</html>
